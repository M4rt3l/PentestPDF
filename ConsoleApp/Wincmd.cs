using PdfSharp.Drawing;
using System.Text.RegularExpressions;

namespace ConsoleApp
{
    class Wincmd
    {
        public static void AddReport(string path)
        {
            if (path != null)
            {
                PDFCreator.champterName = "Windows Commands";
                PDFCreator.champterColor = XBrushes.DodgerBlue;
                PDFCreator.NewPage(true);

                WriteRecordsFromTxt(path);
            }
        }

        public static void WriteRecordsFromTxt(string path) 
        {
            string[] lines = File.ReadAllLines(path);
            string command = "";
            string arguments = "";
            int counter = 0;

            foreach (string line in lines)
            {
                Match match_command = Regex.Match(line, @"^\# Command:\s(\w+)(?:\s(.*))?");
                if (match_command.Success)
                {
                    command = match_command.Groups[1].Value;
                    arguments = match_command.Groups[2].Value;
                    PDFCreator.NewLine(5);
                    PDFCreator.WriteLine($"Command: ", false, PDFCreator.boldFont);
                    PDFCreator.Write($"{command} ", false, PDFCreator.normalFont, XBrushes.DodgerBlue);
                    PDFCreator.Write(arguments);
                }
                else
                {
                    if (command == "whoami")
                    {
                        Match match = Regex.Match(line, @"^([^\s]+)");
                        if (match.Success)
                        {
                            PDFCreator.WriteLine(match.Groups[1].Value, false, PDFCreator.normalFont, XBrushes.Black, 15);
                        }
                    }
                    else if (command == "systeminfo")
                    {
                        Match match = Regex.Match(line, @"^((?:\w+\s)+\w+)\:\s+(.*)");
                        if (match.Success)
                        {
                            PDFCreator.WriteLine($"{match.Groups[1].Value}: ", true, PDFCreator.boldFont, XBrushes.Navy);
                            PDFCreator.Write(match.Groups[2].Value);
                        }
                    }
                    else if (command == "ipconfig")
                    {
                        Match match_name = Regex.Match(line, @"^(.*)\:$");
                        Match match = Regex.Match(line, @"((?:\w+\s)+\w+)(?:\s+)?(?:\.\s)+\:\s+(.*)");

                        if (match_name.Success)
                        {
                            PDFCreator.WriteLine(match_name.Groups[1].Value, true, PDFCreator.boldFont);
                        }
                        else if (match.Success)
                        {
                            string value = match.Groups[2].Value;
                            if (value != "")
                            {
                                string parameter = match.Groups[1].Value;
                                PDFCreator.WriteLine($"{parameter}: ", true, PDFCreator.boldFont, XBrushes.Navy, 15);
                                PDFCreator.Write(value);
                            }
                        }
                    }
                    else if (command == "tracert")
                    {
                        Match match = Regex.Match(line, @"(\d)\s+(\<?\d+\ ms)\s+(\<?\d+\ ms)\s+(\<?\d+\ ms)\s+(.*)");
                        if (match.Success)
                        {
                            PDFCreator.WriteLine($"hop {match.Groups[1].Value}: ", true, PDFCreator.normalFont, XBrushes.Black);
                            PDFCreator.Write($"{match.Groups[2].Value} {match.Groups[3].Value} {match.Groups[4].Value} ");
                            PDFCreator.Write(match.Groups[5].Value);
                        }
                    }
                    else if (command == "nslookup")
                    {
                        Match match = Regex.Match(line, @"^(\w+)\:\s+(.*)");
                        if (match.Success)
                        {
                            PDFCreator.WriteLine($"{match.Groups[1].Value}: ", true, PDFCreator.boldFont);
                            PDFCreator.Write(match.Groups[2].Value);
                        }
                    }
                    else if (command == "netstat")
                    {
                        Match match = Regex.Match(line, @"^\s+(\w{3})\s+([^\s]+)\s+([^\s]+)(?:\s+([^\s]+))?");
                        XBrush stateColor;

                        if (match.Success)
                        {
                            counter++;
                            PDFCreator.WriteLine($"Connection {counter}: ", true, PDFCreator.boldFont);

                            PDFCreator.WriteLine("Protocol: ", true, PDFCreator.boldFont, XBrushes.Navy, 15);
                            PDFCreator.Write(match.Groups[1].Value);
                            PDFCreator.WriteLine("Local address: ", true, PDFCreator.boldFont, XBrushes.Navy, 15);
                            PDFCreator.Write(match.Groups[2].Value);
                            PDFCreator.WriteLine("Foreign address: ", true, PDFCreator.boldFont, XBrushes.Navy, 15);
                            PDFCreator.Write(match.Groups[3].Value);

                            string state = match.Groups[4].Value;
                            if (state != "")
                            {
                                if (state == "ESTABLISHED") { stateColor = XBrushes.Green; }
                                else if (state == "TIME_WAIT") { stateColor = XBrushes.Orange; }
                                else if (state == "LISTENING") { stateColor = XBrushes.Red; }
                                else if (state == "CLOSE_WAIT") { stateColor = XBrushes.Orange; }
                                else { stateColor = XBrushes.Black; }

                                PDFCreator.WriteLine("State: ", true, PDFCreator.boldFont, XBrushes.Navy, 15);
                                PDFCreator.Write($"{state}", false, PDFCreator.normalFont, stateColor);
                            }
                        }
                    }
                }
            }
        }
    }
}
