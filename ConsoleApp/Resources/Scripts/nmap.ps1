### NMAP AUTOMATED RUN SCRIPT ###
# The silent installation option has been charged since version 7.90 (need ncap OEM)
# That is why version 7.80 is used

param (
    [string]$desktopPath = [System.Environment]::GetFolderPath('Desktop'),
    [string]$target = "127.0.0.1"
)

$scriptsDirectory = Split-Path -Path $MyInvocation.MyCommand.Path -Parent
$baseDirectory = Split-Path -Path $scriptsDirectory -Parent
$toolsDirectory = "$baseDirectory\Tools"

$nmapPath = "C:\Program Files (x86)\Nmap\nmap.exe"

if (-not (Test-Path $nmapPath)) {
    $installerPath = "$toolsDirectory\nmap-7.80.exe"
    try {
        Start-Process -FilePath $installerPath /S -Wait # silent install nmap
        Write-Host "  $(Split-Path $installerPath -Leaf) successfully installed."
    } catch {
        Write-Host "  $(Split-Path $installerPath -Leaf) installation failed."
    }
}

$outputsDirectory = "$desktopPath\Outputs"
$outputPath = "$outputsDirectory\nmap.xml"

if (-not (Test-Path $outputsDirectory)) {
    New-Item -Path $outputsDirectory -ItemType Directory
}

$nmapArgs = "-p- -sS"
# –p- : search all 65535 ports
# -sS : scan of ports TCP SYN
# –A : finds services and operating system info
$args = "$target $nmapArgs -oX $outputPath"

if (Test-Path $nmapPath) {
    Start-Process -FilePath $nmapPath -ArgumentList $args -NoNewWindow -Wait -RedirectStandardOutput "$env:TEMP\nmap.txt"
}