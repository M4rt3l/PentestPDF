using PdfSharp.Drawing;
using System.Text.RegularExpressions;

namespace RunApp
{
    class Nikto
    {
        static string? version;
        static string? host;
        static string? port;

        public static void AddReport(string path)
        {
            if (path != null)
            {
                PDF.champterName = "Nikto";
                PDF.champterColor = XBrushes.Goldenrod;
                PDF.NewPage(true);

                List<(string, string, string)> records = ReadTxt(path);
                WriteRecords(records);
            }
        }

        public static void WriteRecords(List<(string, string, string)> records)
        {
            PDF.WriteTitle("Nikto: ");
            if (version != null)
            {
                PDF.WriteLine("Version: ", true, PDF.boldFont);
                PDF.Write(version);
            }

            if (host != null && port != null)
            {
                PDF.WriteLine($"Target: ", true, PDF.boldFont);
                PDF.Write($"{host}:");
                PDF.Write(port, false, PDF.normalFont, PDF.champterColor);
            }

            if (records != null)
            {
                PDF.WriteTitle("Records: ");
                foreach (var record in records)
                {
                    PDF.WriteLine($"{record.Item1}", true, PDF.boldFont, PDF.champterColor);
                    PDF.Write($": {record.Item2}.");
                    if (record.Item3 != "")
                    {
                        PDF.WriteLine($"(Note: {record.Item3})", false, PDF.normalFont, XBrushes.DodgerBlue, 15);
                    }
                }
            }
        }

        public static List<(string, string, string)> ReadTxt(string niktoPath)
        {

            string[] lines = File.ReadAllLines(niktoPath);
            List<(string, string, string)> records = new();

            string pattern_record = @"\+ HEAD\s([^:]+)\:\s([^.]+)\.(?:\s\(NOTE:\s([^)]+)\))?";
            string pattern_version = @"Nikto v([\d.]+)";
            string pattern_host = @"Target Host:\s([\d.]+)";
            string pattern_port = @"Target Port:\s(\d+)";

            foreach (string line in lines)
            {
                Match match_record = Regex.Match(line, pattern_record);
                Match match_version = Regex.Match(line, pattern_version);
                Match match_host = Regex.Match(line, pattern_host);
                Match match_port = Regex.Match(line, pattern_port);

                if (match_record.Success)
                {
                    string filePath = match_record.Groups[1].Value;
                    string message = match_record.Groups[2].Value;
                    string note = match_record.Groups[3].Value;

                    records.Add((filePath, message, note));
                }
                else if (match_version.Success)
                {
                    version = match_version.Groups[1].Value;
                }
                else if (match_host.Success)
                {
                    host = match_host.Groups[1].Value;
                }
                else if (match_port.Success)
                {
                    port = match_port.Groups[1].Value;
                }
            }
            return records;
        }

    }
}
