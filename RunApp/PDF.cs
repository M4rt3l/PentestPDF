using PdfSharp.Drawing;
using PdfSharp.Pdf;
using System.Diagnostics;

namespace RunApp
{
    public class PDF
    {
        public static PdfDocument document;
        public static PdfPage page;
        public static XGraphics gfx;

        public static XFont normalFont = new("Arial", 10, XFontStyle.Regular);
        public static XFont boldFont = new("Arial", 10, XFontStyle.Bold);
        public static XBrush champterColor = XBrushes.Black;

        public static string champterName;
        public static string dateTime;
        public static double posY;
        public static double lastPosX;
        public static int paging;
        public const double padding = 70;

        private static void Initialize()
        {
            System.Text.Encoding.RegisterProvider(System.Text.CodePagesEncodingProvider.Instance);

            document = new PdfDocument();
            page = document.AddPage();
            gfx = XGraphics.FromPdfPage(page);

            champterName = "Title page";
            dateTime = $"{DateTime.Now:dd.MM.yyyy HH:mm}";
            paging = 0;
        }

        public static void Create(string workDirectory, bool postOpen)
        {
            Initialize();
            ArrangeFirstPage();

            string outputsDirectory = Path.Combine(workDirectory, "Outputs");

            WriteContent(outputsDirectory);
            Save(workDirectory, postOpen);
        }

        private static void ArrangeFirstPage()
        {
            double width = 300;
            DrawImage(Properties.Resources.fai_logo,
                page.Width / 2 - width / 2, padding + 20, width);

            posY = page.Height / 2;
            WriteTitle("Automated pentest report", 0, 0, true, new("Arial", 24, XFontStyle.Bold));
            WriteTitle("Created as part of a diploma thesis", 5, 0, true);

            string text = $"{DateTime.Now:dd.MM.yyyy}";
            double textWidth = gfx.MeasureString(text, normalFont).Width;
            gfx.DrawString(text, normalFont, XBrushes.Black,
                new XPoint(page.Width - padding - textWidth, page.Height - padding));

            text = "Created: ";
            textWidth += gfx.MeasureString(text, boldFont).Width;
            gfx.DrawString(text, boldFont, XBrushes.Black,
                new XPoint(page.Width - padding - textWidth, page.Height - padding));
        }

        private static void DrawImage(Bitmap bitmap, double x, double y, double width)
        {
            using (MemoryStream stream = new MemoryStream())
            {
                bitmap.Save(stream, System.Drawing.Imaging.ImageFormat.Png);
                XImage image = XImage.FromStream(stream);

                double aspectRatio = image.Width / image.Height;
                double height = width / aspectRatio;
                gfx.DrawImage(image, x, y, width, height);
            }
        }

        private static void WriteContent(string workDirectory)
        {
            string[] xmlPaths = Directory.GetFiles(workDirectory, "nmap*.xml");
            foreach (string path in xmlPaths)
            {
                Nmap.AddReport(path);
            }

            string[] txtPaths = Directory.GetFiles(workDirectory, "*.txt");
            foreach (string path in txtPaths)
            {
                if (path.Contains("sqlmap"))
                {
                    Sqlmap.AddReport(path);
                }
                else if(path.Contains("mimikatz"))
                {
                    Mimikatz.AddReport(path);
                }
                else if (path.Contains("nikto"))
                {
                    Nikto.AddReport(path);
                }
                else if (path.Contains("wincmd"))
                {
                    Wincmd.AddReport(path);
                }
            }
        }

        public static void Write(string text, bool bullet = false, XFont? font = null, XBrush? brush = null, double posX = 0)
        {
            posX = posX == 0 ? lastPosX : (padding + posX);
            font = font == null ? normalFont : font;
            brush = brush == null ? XBrushes.Black : brush;

            double stringWidth = 0;
            double charWidth;
            double lineWidth;
            double lineHeight = font.GetHeight();

            if (posY >= page.Height - padding) 
            { 
                NewPage();
                NewLine(lineHeight);
            }

            if (bullet) { posX = WriteBullet(posX); }

            lineWidth = page.Width - posX - padding;

            foreach (char character in text)
            {
                charWidth = gfx.MeasureString(character.ToString(), font).Width;

                if (stringWidth + charWidth > lineWidth)
                {
                    NewLine(lineHeight);

                    if (posY >= page.Height - padding) 
                    { 
                        NewPage();
                        NewLine(lineHeight);
                    }

                    stringWidth = 0;
                }

                gfx.DrawString(character.ToString(), font, brush,
                    new XPoint(posX + stringWidth, posY));

                stringWidth += charWidth;
            }
            lastPosX = posX + stringWidth;
        }

        public static void WriteLine(string text, bool bullet = false, XFont? font = null, XBrush? brush = null, double posX = 0)
        {
            font = font == null ? normalFont : font;
            double lineHeight = font.GetHeight();

            if (posY >= page.Height - padding) { NewPage(); }
            NewLine(lineHeight);
            lastPosX = padding; // reset

            Write(text, bullet, font, brush, posX);
        }

        public static void WriteTitle(string title, double paddingTop = 5, double paddingBottom = 2, bool center = false, XFont? font = null, XBrush? brush = null)
        {
            font = font == null ? new("Arial", 12, XFontStyle.Bold) : font;
            brush = brush == null ? XBrushes.Black : brush;

            NewLine(paddingTop);
            if (center)
            {
                XSize textSize = gfx.MeasureString(title, font);
                double posX = page.Width / 2 - textSize.Width / 2;
                WriteLine($"{title}", false, font, brush, posX - padding);
            }
            else
            {
                WriteLine($"{title}", false, font, brush);
            }
            NewLine(paddingBottom);
        }

        public static void NewLine(double lineHeight)
        {
            posY += (lineHeight * 1.25);
        }

        public static void NewPage(bool firstPage = false)
        {
            page = document.AddPage();
            gfx.Dispose();
            gfx = XGraphics.FromPdfPage(page);
            posY = padding; //reset

            WriteHeader(firstPage);
            WritePaging();
        }

        public static void WriteSeparator(double space = 0)
        {
            posY += space;
            gfx.DrawLine(new XPen(XColors.Black, 0.5),
                new XPoint(padding, posY),
                new XPoint(page.Width - padding, posY));
        }

        private static double WriteBullet(double posX)
        {
            posX += 5;
            gfx.DrawString($"\u2022", normalFont, XBrushes.Black, new XPoint(posX, posY));
            posX += 10;

            return posX;
        }

        private static void WriteHeader(bool firstPage)
        {
            if (firstPage)
            {
                WriteLine($"{champterName} scan report", false,
                    new XFont("Arial", 20, XFontStyle.Bold), champterColor);
                WriteLine($"Created: ", false, boldFont);
                Write(dateTime);
                WriteSeparator(5);
            }
            else
            {
                XSize size = gfx.MeasureString(champterName, boldFont);

                gfx.DrawString(champterName, boldFont, champterColor,
                new XPoint(
                    page.Width - padding - size.Width,
                    padding - size.Height * 0.5));
                gfx.DrawLine(new XPen(XColors.Black, 0.5),
                    new XPoint(padding, padding),
                    new XPoint(page.Width - padding, padding));
            }
        }

        private static void WritePaging()
        {
            paging++;
            string text = $"page {paging}";
            XSize size = gfx.MeasureString(text, boldFont);

            gfx.DrawString(text, boldFont, XBrushes.Black,
                new XPoint(
                    page.Width - padding - size.Width,
                    page.Height - padding + size.Height * 1.25));
            gfx.DrawLine(new XPen(XColors.Black, 0.5),
                new XPoint(padding, page.Height - padding),
                new XPoint(page.Width - padding, page.Height - padding));
        }

        private static void Save(string workDirectory, bool openOnClose)
        {
            string outputName = $"report_{DateTime.Now:dd-MM-yyyy_HH-mm}";
            string outputPath = Path.Combine(workDirectory, $"{outputName}.pdf");

            document.Save(outputPath);
            document.Close();
            if (openOnClose)
            {
                OpenFile(outputPath);
            }
        }

        private static void OpenFile(string path)
        {
            if (File.Exists(path))
            {
                Process.Start("explorer.exe", path);
            }
        }
    }
}