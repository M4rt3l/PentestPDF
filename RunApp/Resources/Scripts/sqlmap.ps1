### SQLMAP AUTOMATED RUN SCRIPT ###

param (
    [string]$desktopPath = [System.Environment]::GetFolderPath('Desktop'),
    [string]$target = "127.0.0.1"
)

$scriptsDirectory = Split-Path -Path $MyInvocation.MyCommand.Path -Parent
$baseDirectory = Split-Path -Path $scriptsDirectory -Parent
$toolsDirectory = "$baseDirectory\Tools"

$sqlmapPath = "$toolsDirectory\sqlmap\sqlmap.py"

if (-not (Test-Path $sqlmapPath)) {
    $zipPath = "$toolsDirectory\sqlmap-1.8.4.zip"
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, "$toolsDirectory\sqlmap")
        Write-Host "  $(Split-Path $zipPath -Leaf) successfully extracted."
    } catch {
        Write-Host "  $(Split-Path $zipPath -Leaf) Extraction failed."
    }
}

$pythonPath = "C:\Python27\python.exe"

if (-not (Test-Path $pythonPath)) {
    $installerPath = "$toolsDirectory\python-2.7.17.msi"
    $args = "/qn /i `"$installerPath`""
    try {
        Start-Process -FilePath msiexec.exe -ArgumentList $args -Wait
        Write-Host "  $(Split-Path $installerPath -Leaf) successfully installed."
    } catch {
        Write-Host "  $(Split-Path $installerPath -Leaf) installation failed."
    }
}

$outputsDirectory = "$desktopPath\Outputs"
$outputPath = "$outputsDirectory\sqlmap.txt"

if (-not (Test-Path $outputsDirectory)) {
    New-Item -Path $outputsDirectory -ItemType Directory
}

if ((Test-Path $pythonPath) -and (Test-Path $sqlmapPath)) {
    $command = "$pythonPath $sqlmapPath -u $target -crawl=1 --batch"
    Invoke-Expression $command | Out-File -FilePath $outputPath -Append

    # second option of running this command
    #& $command > $outputPath
}